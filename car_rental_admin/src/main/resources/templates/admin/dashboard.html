<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Admin Dashboard - Auto Rent Da Nang</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="admin-container">
    <!-- Sidebar -->
    <div th:replace="fragments/sidebar :: admin-sidebar"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div th:replace="fragments/navbar :: admin-navbar"></div>
        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Total Vehicles</h3>
                        <p class="stat-number">0</p>

                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Today's Bookings</h3>
                        <p class="stat-number">0</p>

                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Monthly Revenue</h3>
                        <p class="stat-number">$0</p>

                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>New Customers</h3>
                        <p class="stat-number">0</p>

                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>7-Day Revenue</h3>
                        <select class="chart-filter" id="chart-range">
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="90">3 months</option>
                        </select>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Most Rented Vehicles</h3>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="popularCarsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="activities-section">
                <div class="section-header">
                    <h3>Recent Activities</h3>
                </div>

                <div class="activities-list"></div>
            </div>

        </div>
    </main>
</div>
<script>
    // Chart.js data containers
    let dashboardData = { revenue: [], popularCars: [] };
    let revenueChart = null;
    let popularCarsChart = null;

    // Format currency helper
    function formatCurrency(value) {
        return "$" + Number(value).toLocaleString();
    }

    // Load dashboard data and render
    function loadDashboardData() {
        fetch('/admin/dashboard/data')
            .then(response => response.json())
            .then(data => {
                // Stats Cards
                document.querySelectorAll('.stat-number')[0].textContent = data.totalVehicles;
                document.querySelectorAll('.stat-number')[1].textContent = data.todayBookings;
                document.querySelectorAll('.stat-number')[2].textContent = formatCurrency(data.monthlyRevenue);
                document.querySelectorAll('.stat-number')[3].textContent = data.newCustomers;
                // If backend supplies change text, update it:
                if (data.totalVehiclesChangeText) document.getElementById('vehicles-change').textContent = data.totalVehiclesChangeText;
                if (data.todayBookingsChangeText) document.getElementById('bookings-change').textContent = data.todayBookingsChangeText;
                if (data.monthlyRevenueChangeText) document.getElementById('revenue-change').textContent = data.monthlyRevenueChangeText;
                if (data.newCustomersChangeText) document.getElementById('customers-change').textContent = data.newCustomersChangeText;

                // Charts
                dashboardData.revenue = data.revenueStats;
                dashboardData.popularCars = data.popularCars;
                initializeCharts();

                // Recent Activities
                const activitiesList = document.querySelector('.activities-list');
                activitiesList.innerHTML = "";
                data.recentActivities.forEach(act => {
                    activitiesList.innerHTML += `
                      <div class="activity-item">
                        <div class="activity-icon">
                          <i class="${act.icon}"></i>
                        </div>
                        <div class="activity-content">
                          <p>${act.content}</p>
                          <span class="activity-time">${act.time}</span>
                        </div>
                        <div class="activity-status ${act.statusClass}">${act.statusText}</div>
                      </div>
                    `;
                });
            });
    }

    function initializeCharts() {
        initRevenueChart();
        initPopularCarsChart();
    }

    function initRevenueChart() {
        const ctx = document.getElementById("revenueChart");
        if (!ctx) return;
        if (revenueChart) revenueChart.destroy();
        revenueChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: dashboardData.revenue.map((item) =>
                    new Date(item.date).toLocaleDateString("vi-VN", {
                        month: "short",
                        day: "numeric",
                    })
                ),
                datasets: [
                    {
                        label: "Doanh thu (VNĐ)",
                        data: dashboardData.revenue.map((item) => item.amount),
                        borderColor: "#2563eb",
                        backgroundColor: "rgba(37, 99, 235, 0.1)",
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: "#f97316",
                        pointBorderColor: "#2563eb",
                        pointBorderWidth: 2,
                        pointRadius: 6,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return (value / 1000000).toFixed(1) + "M";
                            },
                        },
                        grid: { color: "rgba(0, 0, 0, 0.1)" },
                    },
                    x: { grid: { color: "rgba(0, 0, 0, 0.1)" } },
                },
                elements: { point: { hoverRadius: 8 } },
                animation: { duration: 1000 },
            },
        });
    }

    function initPopularCarsChart() {
        const ctx = document.getElementById("popularCarsChart");
        if (!ctx) return;
        if (popularCarsChart) popularCarsChart.destroy();
        popularCarsChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: dashboardData.popularCars.map((car) => car.name),
                datasets: [
                    {
                        data: dashboardData.popularCars.map((car) => car.bookings),
                        backgroundColor: [
                            "#2563eb",
                            "#f97316",
                            "#059669",
                            "#dc2626",
                            "#8b5cf6",
                        ],
                        borderWidth: 0,
                        hoverBorderWidth: 3,
                        hoverBorderColor: "#ffffff",
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: { size: 12 },
                        },
                    },
                },
                cutout: "60%",
                animation: { duration: 1000 },
            },
        });
    }

    // Report export (unchanged)
    function generateReport() {
        // Simulate report generation for now...
        showToast("Đang tạo báo cáo...", "info");
        setTimeout(() => {
            showToast("Báo cáo đã được tải xuống thành công!", "success");
        }, 2000);
    }

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        toast.innerHTML = `
            <div class="toast-content">
                <i class="${icon}"></i>
                <span>${message}</span>
            </div>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toastContainer.removeChild(toast); }, 300);
        }, 3000);
    }

    // Call loadDashboardData on page load
    document.addEventListener("DOMContentLoaded", loadDashboardData);

    // Optionally, reload data every 5 minutes
    setInterval(loadDashboardData, 5 * 60 * 1000);
</script>
<div id="toast-container"></div>
<style>
    /* Toast styling tương tự như login */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
    }
    .toast {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        padding: 16px 20px;
        min-width: 300px;
        transform: translateX(400px);
        transition: all 0.3s ease-in-out;
        opacity: 0;
        border-left: 4px solid #28a745;
    }
    .toast.toast-success { border-left-color: #28a745; }
    .toast.toast-error { border-left-color: #dc3545; }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast-content { display: flex; align-items: center; gap: 10px; }
    .toast-content i { font-size: 18px; color: #28a745; }
    .toast.toast-error .toast-content i { color: #dc3545; }
    .toast-content span { font-size: 14px; font-weight: 500; color: #333; }
</style>
<script th:src="@{/js/main.js}"></script>
<!-- Import thư viện SockJS và StompJS trước -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:src="@{/js/websocket-notify.js}"></script>
</body>
</html>